<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Management System</title>
    <style>
        body { font-family: Arial, sans-serif; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h2>File Management System</h2>

    <form id="file-form">
        <label for="fileName">File Name:</label>
        <input type="text" id="fileName" name="fileName" required><br><br>

        <label for="fileNo">File No:</label>
        <input type="text" id="fileNo" name="fileNo" required><br><br>

        <label for="issueDate">Issue Date:</label>
        <input type="date" id="issueDate" name="issueDate" required><br><br>

        <label for="dealingAssistant">Dealing Assistant:</label>
        <input type="text" id="dealingAssistant" name="dealingAssistant" required><br><br>

        <label for="details">Details:</label>
        <input type="text" id="details" name="details" required><br><br>

        <button type="submit">Submit</button>
    </form>

    <h3>Saved Files</h3>
    <table id="file-table">
        <thead>
            <tr>
                <th>File Name</th>
                <th>File No</th>
                <th>Issue Date</th>
                <th>Dealing Assistant</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <h3>File Details from URL:</h3>
    <p>File Name: <span id="fileNameDisplay"></span></p>
    <p>File No: <span id="fileNoDisplay"></span></p>
    <p>Issue Date: <span id="issueDateDisplay"></span></p>
    <p>Dealing Assistant: <span id="dealingAssistantDisplay"></span></p>
    <p>Details: <span id="detailsDisplay"></span></p>

<script>
    const repoOwner = "Dibyenduchoudhury";
    const repoName = "Central-Register";
    const filePath = "files.json";
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

    document.getElementById('file-form').addEventListener('submit', async function (event) {
        event.preventDefault();

        const fileName = document.getElementById('fileName').value;
        const fileNo = document.getElementById('fileNo').value;
        const issueDate = document.getElementById('issueDate').value;
        const dealingAssistant = document.getElementById('dealingAssistant').value;
        const details = document.getElementById('details').value;

        const newFileData = { fileName, fileNo, issueDate, dealingAssistant, details };
        
        const githubToken = "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";  // Replace with actual token
        const apiUrl = `https://api.github.com/repos/Dibyenduchoudhury/Central-Register/contents/files.json`;

        try {
            const response = await fetch(apiUrl, {
                headers: {
                    "Authorization": `Bearer ${githubToken}`,
                    "Accept": "application/vnd.github.v3+json"
                }
            });

            if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);

            const data = await response.json();
            const sha = data.sha;

            let existingFiles = JSON.parse(atob(data.content));
            existingFiles.push(newFileData);
            const updatedContent = btoa(JSON.stringify(existingFiles, null, 2));

            const updateResponse = await fetch(apiUrl, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${githubToken}`,
                    "Accept": "application/vnd.github.v3+json"
                },
                body: JSON.stringify({
                    message: "Added new file record",
                    content: updatedContent,
                    sha: sha
                })
            });

            if (!updateResponse.ok) throw new Error(`GitHub Update Error: ${updateResponse.status}`);

            alert("File data successfully saved!");
            addFileToTable(newFileData);
            this.reset();

        } catch (error) {
            console.error("Error updating GitHub file:", error);
            alert("Failed to update file on GitHub. Check console for details.");
        }
    });

    async function loadFileData() {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);

            const data = await response.json();
            const decodedContent = atob(data.content).trim();

            if (!decodedContent || decodedContent === "[]") {
                console.warn("files.json is empty!");
                document.getElementById('file-table').innerHTML += "<tr><td colspan='5'>No records found.</td></tr>";
                return;
            }

            let files = JSON.parse(decodedContent);
            files.forEach(file => addFileToTable(file));

        } catch (error) {
            console.error("Fetch Error:", error);
            alert("An error occurred while fetching file data.");
        }
    }

    function addFileToTable(fileData) {
        const table = document.getElementById('file-table').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();

        newRow.insertCell(0).innerText = fileData.fileName;
        newRow.insertCell(1).innerText = fileData.fileNo;
        newRow.insertCell(2).innerText = fileData.issueDate;
        newRow.insertCell(3).innerText = fileData.dealingAssistant;
        newRow.insertCell(4).innerText = fileData.details;
    }

    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        document.getElementById("fileNameDisplay").textContent = urlParams.get("fileName") || "N/A";
        document.getElementById("fileNoDisplay").textContent = urlParams.get("fileNo") || "N/A";
        document.getElementById("issueDateDisplay").textContent = urlParams.get("issueDate") || "N/A";
        document.getElementById("dealingAssistantDisplay").textContent = urlParams.get("dealingAssistant") || "N/A";
        document.getElementById("detailsDisplay").textContent = urlParams.get("details") || "N/A";

        loadFileData();
    };
</script>
</body>
</html>
